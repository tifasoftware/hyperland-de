#!/bin/bash

list_profiles() {
  powerprofilesctl list | \
    awk '/^\s*[* ]\s*[a-zA-Z0-9\-]+:$/ {
      if (/^\*/) {
        gsub(/^[*[:space:]]+|:$/,"");
        print "* " $0
      } else {
        gsub(/^[[:space:]]+|:$/,"");
        print
      }
    }' | \
    tac
}

get_current() {
  powerprofilesctl list | \
    awk '/^\*/ { gsub(/^[*[:space:]]+|:$/,""); print; exit }'
}

set_profile() {
  local profile="$1"
  powerprofilesctl set "$profile"
  notify-send "Power Profile" "Set to: $profile" -i power-profile-$profile
}

if [[ "$1" == "--select" ]]; then
  profiles=$(list_profiles)

  if [[ -z "$profiles" ]]; then
    notify-send "Error" "No power profiles found"
    exit 1
  fi

  selected=$(echo "$profiles" | walker --dmenu --theme menus --width 295 --minheight 1 --maxheight 600 -p "Power Profile" 2>/dev/null)

  if [[ "$selected" == "CNCLD" || -z "$selected" ]]; then
    exit 0
  fi

  selected=$(echo "$selected" | tr -d '\n' | xargs | sed 's/^\* //')

  set_profile "$selected"
elif [[ "$1" == "--dmenu" ]]; then
  list_profiles
elif [[ -n "$1" ]]; then
  set_profile "$1"
else
  get_current
fi
